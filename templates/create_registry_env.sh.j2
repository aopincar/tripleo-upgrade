#!/bin/bash
#
# Create environment file with the registry used by the overcloud nodes
set -euo pipefail

{% if upstream_container_images  %}
{% if use_local_docker_registry  %}
echo > {{ containers_default_parameters }} 'parameter_defaults:
  DockerNamespace: {{ ansible_br_ctlplane.ipv4.address }}:8787/tripleoupstream
  DockerNamespaceIsRegistry: true
'
{% endif %}
{% else %}
REPO="$(find /etc/yum.repos.d/ -iname 'rhos-release-??.*')"
REPO_URL="$(grep -B2 enabled=1 $REPO | grep -m1 puddle | sed -E 's/.*(http.*[0-9]-RHEL-.\/).*/\1/')"
curl -L -o  {{ containers_default_parameters }} $REPO_URL/latest_containers/docker-osp12.yaml
{% if use_local_docker_registry  %}
sed -i s/DockerNamespace:.*/DockerNamespace:\ {{ ansible_br_ctlplane.ipv4.address }}:8787/rhosp12/ {{ containers_default_parameters }}
{% endif %}
{% endif %}
